这个命令将在当前连接的主节点和它的一个副本之间启动一个协调的故障切换。
故障切换不是同步的，而是一个后台任务将处理故障切换的协调。
它旨在在故障切换期间限制数据丢失和集群的不可用性。
这个命令类似于非集群 Redis 的 `CLUSTER FAILOVER` 命令，并且类似于 sentinel 提供的故障切换支持。

默认故障转移流程的具体细节如下：

1. 主节点将内部启动一个"CLIENT PAUSE WRITE"，暂停接收写入操作，并阻止复制流中新数据的累积。
2. 主节点将监视其副本，等待副本指示已完全消费复制流。如果主节点有多个副本，它只会等待第一个副本追赶上。
3. 主节点将降级为副本。这样做是为了防止双主节点情况发生。注意：主节点不会丢弃其数据，因此如果副本在下一步中拒绝故障切换请求，主节点将能够回滚。
4. 前任主节点将向目标副本发送一个特殊的PSYNC请求，"PSYNC FAILOVER"，指示目标副本成为主节点。
5. 一旦前任主节点收到"PSYNC FAILOVER"被接受的确认，它将取消暂停其客户端操作。如果PSYNC请求被拒绝，主节点将中止故障切换，并恢复正常状态。

`INFO replication`中的字段`master_failover_state`可以用来跟踪故障切换的当前状态，可能的取值有：

* `no-failover`：目前没有正在进行的协调故障转移。
* `waiting-for-sync`：主节点正在等待副本节点赶上其复制偏移量。
* `failover-in-progress`：主节点已经降级，正在尝试将所有权移交给目标副本节点。

如果前一个主节点附加了其他的副本，它们将继续作为链式副本从中复制。您需要在这些副本上手动执行 `REPLICAOF` 命令，以便直接从新的主节点开始复制。

## 可选参数
以下是用于修改故障转移流程行为的可选参数：

* `TIMEOUT` *milliseconds* -- 此选项允许指定主节点在“等待同步”状态下等待的最长时间，然后中止故障切换尝试并回滚。
其目的是设定 Redis 集群可能经历的写入停顿的上限。
故障切换通常在一秒内完成，但如果存在大量写入流量或副本已经滞后于消费复制流，则可能需要更长时间。
如果未指定此值，则超时可以被视为“无限”。

* `TO` *主机* *端口* - 此选项允许指定一个特定的副本，通过其主机和端口来进行故障切换。主服务器将等待特定的副本追赶到其复制偏移量，然后进行故障切换至该副本。

* `FORCE` - 如果同时设置了`TIMEOUT`和`TO`选项，则可以使用force标志来指定一旦超时时间到达，主数据库应该进行故障转移，而不是回滚操作。这可用于在数据不丢失的情况下进行最大努力的故障转移，同时限制写操作的中断时间。

注意: 如果目标副本拒绝`PSYNC FAILOVER`请求，主服务器将始终回滚。

## 中止故障切换

`FAILOVER ABORT` 命令旨在避免数据丢失和损坏，但在某些情况下可能会遇到无法自动恢复并可能陷入卡死的情况。
为此，存在`FAILOVER ABORT`命令，它将中止进行中的故障转移并将主服务器恢复到正常状态。
如果在`waiting-for-sync`状态下发出命令，它不会产生任何副作用，但在`failover-in-progress`状态下可能会导致多主服务器场景。
如果遇到多主服务器场景，您需要手动确定哪个主服务器拥有最新的数据并将其指定为主服务器，并对其他副本进行操作。

注意：在故障转移过程中，“REPLICAOF”被禁用，以防止与故障转移产生意外交互，可能导致数据丢失。
