在Redis Cluster中，每个节点都有自己的当前集群配置视图，由已知节点集合、与这些节点的连接状态、它们的标志、属性和分配的槽等组成。

`CLUSTER NODES`提供了所有这些信息，即我们正在联系的节点的当前集群配置，以序列化格式呈现，该格式恰好与Redis Cluster自身用于在磁盘上存储集群状态的格式相同（但磁盘上的集群状态末尾附加了一些附加信息）。

请注意，通常希望获取集群哈希插槽与节点地址之间的映射的客户端应该使用`CLUSTER SLOTS`。`CLUSTER NODES`提供更多信息，应该用于管理任务、调试和配置检查。`redis-cli`也会使用它来管理集群。

## 序列化格式

命令的输出只是一个以空格分隔的CSV字符串，其中每一行表示集群中的一个节点。以下是Redis 7.2.0的输出示例：

```
07c37dfeb235213a872192d90877d0cd55635b91 127.0.0.1:30004@31004,hostname4 slave e7d1eecce10fd6bb5eb35b9f99a514335d9ba9ca 0 1426238317239 4 connected
67ed2db8d677e59ec4a4cefb06858cf2a1a89fa1 127.0.0.1:30002@31002,hostname2 master - 0 1426238316232 2 connected 5461-10922
292f8b365bb7edb5e285caf0b7e6ddc7265d2f4f 127.0.0.1:30003@31003,hostname3 master - 0 1426238318243 3 connected 10923-16383
6ec23923021cf3ffec47632106199cb7f496ce01 127.0.0.1:30005@31005,hostname5 slave 67ed2db8d677e59ec4a4cefb06858cf2a1a89fa1 0 1426238316232 5 connected
824fe116063bc5fcf9f4ffd895bc17aee7731ac3 127.0.0.1:30006@31006,hostname6 slave 292f8b365bb7edb5e285caf0b7e6ddc7265d2f4f 0 1426238317741 6 connected
e7d1eecce10fd6bb5eb35b9f99a514335d9ba9ca 127.0.0.1:30001@31001,hostname1 myself,master - 0 0 1 connected 0-5460
```

每行由以下字段组成：

```
<id> <ip:port@cport[,hostname]> <flags> <master> <ping-sent> <pong-recv> <config-epoch> <link-state> <slot> <slot> ... <slot>
```

每个字段的含义如下：

1. `id`：节点ID，创建节点时生成的40个字符长的全局唯一字符串，除非使用`CLUSTER RESET HARD`，否则不会更改。
2. `ip:port@cport`：客户端应该联系以运行查询的节点地址。
3. `hostname`：一个可通过设置`cluster-annouce-hostname`进行配置的可读字符串。字符串的最大长度为256个字符（不包括空终止符）。名称只能包含ASCII数字、字母、'-'和'.'。
5. `flags`：逗号分隔的标志列表：`myself`、`master`、`slave`、`fail?`、`fail`、`handshake`、`noaddr`、`nofailover`、`noflags`。下面解释了这些标志。
6. `master`：如果节点是副本，并且已知主节点，则为主节点ID；否则为"-"字符。
7. `ping-sent`：发送当前活动ping的Unix时间，如果没有待处理的ping，则为零，以毫秒为单位。
8. `pong-recv`：上次接收到pong的Unix时间，以毫秒为单位。
9. `config-epoch`：当前节点的配置纪元（或版本）（或如果节点是副本，则是当前主节点的配置纪元）。每次发生故障切换时，都会创建一个新的、唯一的、单调递增的配置纪元。如果多个节点声称提供相同的哈希槽位，则具有更高配置纪元的节点获胜。
10. `link-state`：用于节点间集群总线的链接状态。使用此链接与节点进行通信。可以是`connected`（已连接）或`disconnected`（已断开连接）。
11. `slot`：哈希槽位号或范围。从第9个参数开始，但总共可以有多达16384个条目（从未达到上限）。这是由此节点提供的哈希槽位的列表。如果条目只是一个数字，则解析为该数字。如果是一个范围，形式为`start-end`，意味着该节点负责从`start`到`end`的所有哈希槽位，包括起始值和终止值。

标志是：

* `myself`: 你正在联系的节点。
* `master`: 节点是主节点。
* `slave`: 节点是副本节点。
* `fail?`: 节点处于`PFAIL`状态。对于你正在联系的节点而言，无法访问，但在逻辑上可达（不是`FAIL`状态）。
* `fail`: 节点处于`FAIL`状态。对于多个将`PFAIL`状态提升为`FAIL`的节点而言，该节点无法访问。
* `handshake`: 不受信任的节点，我们正在进行握手。
* `noaddr`: 该节点没有已知的地址。
* `nofailover`: 副本将不会尝试故障切换。
* `noflags`: 没有任何标志。

## 发布配置纪元的笔记

复制品广播其主时期（以获取`UPDATE`消息，如果发现它们已过时），因此仅通过检查标记为`myself`的节点可以获得复制品的真实配置时期（在某种程度上是没有意义的，因为它们不提供哈希插槽）。其他复制品时期反映了它们在心跳包中发布的内容，这是它们当前复制的主服务器的配置时期。

## 特殊插槽条目

通常与给定节点关联的哈希槽位有以下几种格式，如上所述：

1. 单个数字：3894
2. 范围：3900-4000

然而节点哈希槽可能处于一种特殊状态，用于在节点重新启动后进行错误通信（AOF/RDB 文件中的键与节点哈希槽配置之间的不匹配），或在进行重新分片操作时。这两种状态分别是**导入**和**迁移**。

两个状态的含义在Redis规范中有解释，但两个状态的要点如下:

* **Importing** 槽位尚未成为节点的哈希槽位的一部分，正在进行迁移。只有在使用`ASK`命令时，节点才接受关于这些槽位的查询。
* **Migrating** 槽位被分配给节点，但正在迁移到其他节点。如果命令中的所有键已经存在，节点将接受查询，否则它将发出所谓的**ASK重定向**，以强制在导入节点中直接创建新的键。

导入和迁移插槽在`CLUSTER NODES`输出中发出如下：

* **Importing slot:** `[slot_number-<-importing_from_node_id]`
* **Migrating slot:** `[slot_number->-migrating_to_node_id]`

以下是几个导入和迁移插槽的示例：

* `[93-<-292f8b365bb7edb5e285caf0b7e6ddc7265d2f4f]`
* `[1002-<-67ed2db8d677e59ec4a4cefb06858cf2a1a89fa1]`
* `[77->-e7d1eecce10fd6bb5eb35b9f99a514335d9ba9ca]`
* `[16311->-292f8b365bb7edb5e285caf0b7e6ddc7265d2f4f]`

请注意，格式中没有任何空格，因此`CLUSTER NODES`的输出格式是纯CSV格式，即使存在这些特殊的槽位也是使用空格作为分隔符。然而，完整的格式解析器应该能够处理它们。

请注意：

1. 迁移和导入槽位只添加到标记为`myself`的节点。此信息对于节点来说是本地的，针对它自己的槽位。
2. 导入和迁移槽位作为**附加信息**提供。如果节点已被指定了特定的哈希槽位，它也将作为哈希槽位列表中的普通数字出现，因此对于对哈希槽位迁移无任何了解的客户端来说，可以跳过这些特殊字段。

**关于在此手册和命令名称中使用的“slave”一词的说明**：从Redis 5开始，Redis项目不再使用“slave”一词，除非是为了向后兼容。不幸的是，在此命令中，“slave”一词是协议的一部分，因此只有当该API被自然弃用时，我们才能删除这种情况。
