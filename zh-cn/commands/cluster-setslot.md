`CLUSTER SETSLOT`负责以不同的方式改变接收节点中哈希槽的状态。根据使用的子命令，它可以：

1. `MIGRATING` 子命令：将哈希槽设置为“迁移”状态。
2. `IMPORTING` 子命令：将哈希槽设置为“导入”状态。
3. `STABLE` 子命令：清除哈希槽的任何导入/迁移状态。
4. `NODE` 子命令：将哈希槽绑定到不同的节点。

命令及其一系列子命令可用于启动和结束集群的实时重新分片操作，这些操作通过将哈希槽设置为在源节点中迁移状态，并在目标节点中导入状态来完成。

每个子命令的文档如下所示。在最后你会找到一个使用该命令以及其他相关命令进行在线resharding的描述。

## CLUSTER SETSLOT `<slot>` MIGRATING `<destination-node-id>`

将槽位 `<slot>` 设置为迁移中，迁移至目标节点 `<destination-node-id>`。

该子命令将一个槽位设置为*migrating*状态。要将槽位设置为该状态，接收命令的节点必须是该槽位的所有者，否则将返回错误。

当插槽处于迁移状态时，节点的行为将发生以下变化：

1. 如果收到关于已存在的键的命令，则按照通常的方式处理该命令。
2. 如果收到关于不存在的键的命令，节点会发出一个 `ASK` 重新定向，要求客户端仅重试将该特定查询发送到目标节点。在这种情况下，客户端不应更新其哈希槽到节点的映射。
3. 如果命令包含多个键，如果所有键都不存在，行为与第二点相同；如果所有键都存在，则行为与第一点相同；然而，如果只有部分键存在，该命令会发出 `TRYAGAIN` 错误，以便对感兴趣的键完成向目标节点的迁移，以便执行多键命令。

## CLUSTER SETSLOT `<slot>` 导入 `<source-node-id>`

这个子命令是`MIGRATING`的反向命令，它准备目标节点从指定的源节点导入键。只有当节点不是指定哈希槽的所有者时，该命令才有效。

当插槽处于导入状态时，节点的行为发生以下变化：

该哈希槽的相关命令被拒绝，并生成常规的`MOVED`重定向，但如果命令跟随一个`ASKING`命令，则会执行该命令。

当处于迁移状态的节点生成`ASK`重定向时，客户端会联系目标节点，并发送`ASKING`，随后立即发送命令。这种方式可以在目标节点执行关于旧节点中不存在的键或已迁移到目标节点的键的命令，以便：

1. 新键总是创建在目标节点中。在哈希槽迁移期间，我们只需要移动旧键，而不是新键。
2. 对于已经迁移的键的命令，会在目标节点（也就是新的哈希槽拥有者）的上下文中正确处理，以保证一致性。
3. 没有使用 `ASKING` 的情况下，行为与通常情况下相同。这可以确保具有错误哈希槽映射的客户端不会因为目标节点的错误而写入，从而创建尚未迁移的键的新版本。

## 将槽位 `<slot>` 设置为稳定状态

这个子命令只是清除槽位中的迁移/导入状态。通过`redis-cli --cluster fix`来修复集群卡在错误状态下通常会自动清除这两个状态，在下一节中会解释使用`SETSLOT ... NODE ...`子命令来完成。

## 集群设置插槽 `<slot>` 节点 `<node-id>`

`NODE`子命令是语义最复杂的一个命令。它将哈希槽与指定的节点关联起来，但该命令仅在特定情况下起作用，并且根据槽的状态有不同的副作用。下面是该命令的预条件和副作用集合。

1. 如果当前的哈希槽归属节点是接收到命令的节点，但对于命令的影响，该哈希槽会被分配给另一个节点，如果接收到命令的节点中仍有该哈希槽的键，则该命令将返回错误。
2. 如果哈希槽处于"迁移"状态，则当哈希槽被分配给另一个节点时，该状态将被清除。
3. 如果接收到命令的节点中的哈希槽处于"导入"状态，并且该命令将该哈希槽分配给该节点（这发生在从一个节点向另一个节点的哈希槽重新分片的最后阶段），则该命令具有以下副作用：A) "导入"状态被清除。B) 如果该节点的配置纪元不是集群中最大的，它会生成一个新的配置纪元，并将新的配置纪元分配给自己。这样，它的新的哈希槽归属将胜过之前故障转移或哈希槽迁移创建的任何过去配置。

请注意，第三步是Redis集群节点在没有其他节点达成一致的情况下创建新的配置纪元的唯一时机。这仅在手动配置操作时发生。然而，这不会创建出两个节点具有相同配置纪元的非瞬态设置，因为Redis集群使用了配置纪元碰撞解决算法。

## Redis 集群实时重分片解释

`CLUSTER SETSLOT`命令是Redis Cluster中用于将一个哈希槽中包含的所有键从一个节点迁移到另一个节点的重要工具。这是迁移的编排方式，还需要其他命令的帮助。我们将拥有当前哈希槽的节点称为`源`节点，我们想要迁移的节点为`目标`节点。

1. 使用 `CLUSTER SETSLOT <slot> IMPORTING <source-node-id>` 命令将目标节点槽位设置为 *importing* 状态。
2. 使用 `CLUSTER SETSLOT <slot> MIGRATING <destination-node-id>` 命令将源节点槽位设置为 *migrating* 状态。
3. 使用 `CLUSTER GETKEYSINSLOT` 命令从源节点获取键，并使用 `MIGRATE` 命令将它们移动到目标节点。
4. 向目标节点发送 `CLUSTER SETSLOT <slot> NODE <destination-node-id>` 命令。
5. 向源节点发送 `CLUSTER SETSLOT <slot> NODE <destination-node-id>` 命令。
6. 向其他主节点发送 `CLUSTER SETSLOT <slot> NODE <destination-node-id>` 命令（可选）。


注意：

* 重要的是步骤1和2的顺序。当源节点配置为重定向时，我们希望目标节点准备好接受ASK重定向。
* 步骤4和5的顺序很重要。
  目标节点负责将更改传播到整个集群。
  如果在将目标节点设置为新的槽位所有者之前，通知源节点并且目标节点崩溃，则该槽位将无所有者，即使成功进行故障转移。
* 步骤6，向未参与重新分片的节点发送SETSLOT，在技术上并不是必需的，因为配置最终会自行传播。
  不过，这是一个好主意，为了尽快停止节点指向已移动哈希槽的错误节点，从而减少重定向以找到正确的节点。
