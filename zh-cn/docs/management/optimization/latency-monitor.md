---
title: "Redis延迟监控"
linkTitle: "延迟监测"
weight: 1
description: 在Redis中发现慢速服务器事件
aliases: [
    /topics/latency-monitor,
    /docs/reference/optimization/latency-monitor
]
---

Redis经常被用于严苛的使用场景，它可以每个实例每秒处理大量的查询，同时还具有对平均响应时间和最坏情况下延迟的严格要求。

虽然Redis是一个内存系统，但它在与操作系统交互方面有不同的方式，例如在持久化到磁盘时的上下文中。此外，Redis实现了丰富的命令集。某些命令是快速执行的，时间复杂度为常数或对数。其他命令是比较慢的O(N)命令，可能导致延迟峰值。

最后，Redis 是单线程的。从每个核心所能执行的工作量和延迟指标的角度来看，这通常是一个优势。但是，它对于延迟而言是一个挑战，因为单线程必须能够以不影响其他服务的方式递增地执行某些任务，例如键过期。

为了这些原因，Redis 2.8.13引入了一个名为**延迟监控**的新特性，帮助用户检查和排除可能的延迟问题。延迟监控由以下概念部分组成：

* 采样不同的延迟敏感代码路径的延迟钩子。
* 按不同事件分割的延迟尖峰的时间序列记录。
* 报告引擎从时间序列中获取原始数据。
* 分析引擎根据测量结果提供人类可阅读的报告和提示。

这个文档的剩余部分介绍了延迟监控子系统的详细信息。有关Redis和延迟的常规主题的更多信息，请参阅[Redis延迟问题的故障排除](/topics/latency)。

## 事件和时间序列

不同的被监控代码路径有不同的名称，并被称为*事件*。
例如，`command` 是一个事件，用来测量可能较慢的命令执行的延迟峰值，而 `fast-command` 则是对 O(1) 和 O(log N) 命令进行监控的事件名称。其他事件不太通用，用于监控 Redis 执行的特定操作。例如，`fork` 事件仅监控 Redis 执行 `fork(2)` 系统调用所花费的时间。

延迟峰值是指运行时间超过配置的延迟阈值的事件。每个监控事件都有一个单独的时间序列与之相关。下面是时间序列的工作方式：

* 每当发生延迟峰值时，都会记录在相应的时间序列中。
* 每个时间序列由160个元素组成。
* 每个元素由一个Unix时间戳和事件执行所需的毫秒数构成。
* 按秒合并发生在同一秒内的同一事件的延迟峰值，取最大的延迟时间。即使对于给定事件连续发生延迟峰值，这可能发生在较低的阈值下，至少有160秒的历史记录可用。
* 记录每个元素的历史最大延迟。

该框架监控并记录这些事件执行时间的延迟峰值：

* `command`：常规命令。
* `fast-command`：O(1) 和 O(log N) 命令。
* `fork`：`fork(2)` 系统调用。
* `rdb-unlink-temp-file`：`unlink(2)` 系统调用。
* `aof-fsync-always`：由 `appendfsync allways` 策略调用时的 `fsync(2)` 系统调用。
* `aof-write`：写入 AOF - `write(2)` 系统调用的综合事件。
* `aof-write-pending-fsync`：有待执行 fsync 时的 `write(2)` 系统调用。
* `aof-write-active-child`：存在活动子进程时的 `write(2)` 系统调用。
* `aof-write-alone`：无待执行 fsync 和无活动子进程时的 `write(2)` 系统调用。
* `aof-fstat`：`fstat(2)` 系统调用。
* `aof-rename`：在完成 `BGREWRITEAOF` 后重命名临时文件的 `rename(2)` 系统调用。
* `aof-rewrite-diff-write`：执行 `BGREWRITEAOF` 期间累积的差异写入。
* `active-defrag-cycle`：主动碎片整理周期。
* `expire-cycle`：过期键处理周期。
* `eviction-cycle`：驱逐键处理周期。
* `eviction-del`：驱逐周期中的删除操作。

## 如何启用延迟监控

对于一个使用案例来说，高延迟可能对另一个使用案例来说并不算是高延迟。有些应用程序可能要求所有查询都在1毫秒内完成。对于另一些应用程序来说，偶尔有一小部分客户端经历2秒延迟可能是可以接受的。

为了启用延迟监视器，第一步是设置以毫秒为单位的**延迟阈值**。只有超过指定阈值的事件才会被记录为延迟峰值。用户应根据自己的需求设置阈值。例如，如果应用程序需要最大可接受的延迟为100毫秒，则阈值应设置为将所有导致服务器阻塞时间等于或大于100毫秒的事件记录下来。

以以下命令在生产服务器上在运行时启用延迟监视器：

    CONFIG SET latency-monitor-threshold 100

默认情况下关闭了监控（阈值设为0），即使实际的延迟监控成本接近于零。虽然延迟监控的内存需求非常小，但没有充分的理由去增加一个工作正常的 Redis 实例的基线内存使用量。

用LATENCY命令报告信息

与延迟监控子系统的用户界面是`LATENCY`命令。
与许多其他Redis命令一样，`LATENCY`接受修改其行为的子命令。这些子命令包括：

* `LATENCY LATEST` - 返回所有事件的最新延迟样本。
* `LATENCY HISTORY` - 返回给定事件的延迟时间序列。
* `LATENCY RESET` - 重置一个或多个事件的延迟时间序列数据。
* `LATENCY GRAPH` - 渲染事件延迟样本的 ASCII 艺术图。
* `LATENCY DOCTOR` - 返回一个可读的延迟分析报告。

请参阅每个子命令的文档页面获取更多信息。
