---
title: "Redis 位图"
linkTitle: "位图"
weight: 120
description: >
    Redis位图简介
---

位图不是一个实际的数据类型，而是一组针对字符串类型的位操作，字符串类型被视为位向量。
由于字符串是二进制安全的二进制大对象（blob），其最大长度为512MB，因此适合设置2^32（4294967296）个不同的位。

您可以对一个或多个字符串执行位运算。
一些位图使用场景的示例包括：

1. 对于集合中的成员与整数0-N相对应的情况，采用高效的集合表示方法。
2. 对象权限，其中每个位表示特定的权限，类似于文件系统存储权限的方式。

## 基本命令

* `SETBIT` 根据提供的偏移量将一个位设置为 0 或 1。
* `GETBIT` 返回给定偏移量处位的值。
* `BITOP` 允许对一个或多个字符串执行位操作。

查看[位图命令的完整列表](https://redis.io/commands/?group=bitmap)。


## 示例

假设您在现场部署了1000个传感器，标记为0-999。
您希望快速确定给定的传感器是否在一小时内向服务器发送了请求。

您可以使用一个位图来表示这种情况，其中键引用当前的小时。

* Sensor 123在2024年1月1日的00:00小时内向服务器发送了ping信号。
```
> SETBIT pings:2024-01-01-00:00 123 1
(integer) 0
```

* 传感器123在2024年1月1日的00:00小时内是否ping了服务器？

```
> GETBIT pings:2024-01-01-00:00 123
1
```


* 传感器456的情况如何？
```
> GETBIT pings:2024-01-01-00:00 456
0
```



位操作分为两组：常数时间单个位操作，如将位设置为1或0，或获取其值，以及对位组进行操作，例如计算给定位范围内设置位的数量（例如，种群计数）。

位图的最大优势之一就是在存储信息时通常能提供极高的空间节省。例如，在一个用户由增量用户 ID 表示的系统中，只用 512 MB 的内存就能记住 40 亿用户的单个位信息（例如，知道一个用户是否想接收通讯）是可能的。

使用`SETBIT`和`GETBIT`命令来设置和检索位信息：

    > setbit key 10 1
    (integer) 0
    > getbit key 10
    (integer) 1
    > getbit key 11
    (integer) 0

`SETBIT` 命令的第一个参数是位数，第二个参数是要设置的值，可以是1或0。该命令会自动扩展字符串长度，以适应位数超出当前字符串长度的情况。

`GETBIT`只返回指定索引处的位的值。
超出范围的位（指定地址位于存储在目标键中的字符串的长度之外）始终被视为零。

有三个操作用于位组：

1. `BITOP`在不同的字符串之间执行按位操作。提供的操作有AND、OR、XOR和NOT。
2. `BITCOUNT`执行种群计数，报告设置为1的位数。
3. `BITPOS`找到具有指定值0或1的第一位。

`BITPOS`和`BITCOUNT`都可以在字符串的字节范围内进行操作，而不是针对整个字符串的整个长度运行。以下是一个`BITCOUNT`调用的简单示例：

    > setbit key 0 1
    (integer) 0
    > setbit key 100 1
    (integer) 0
    > bitcount key
    (integer) 2

例如，假设你想要知道你网站用户的连续访问天数的最长记录。你从零开始计算天数，也就是你网站公开的那一天，并且每次用户访问网站时都用`SETBIT`设置一个位。作为位索引，你只需要取当前的Unix时间，减去初始偏移量，然后除以一天的秒数（通常是3600*24）。

对于每个用户，您可以使用一个包含每天访问信息的小字符串。使用`BITCOUNT`函数可以轻松获取给定用户访问网站的天数，同时使用几个`BITPOS`函数，或者在客户端获取和分析位图，可以轻松计算最长连续访问天数。

可以轻松地将位图拆分成多个键，例如为了分片数据集以及通常情况下更好地避免使用巨大的键。为了将位图拆分到不同的键中，而不是将所有位设置到一个键中，一种简单的策略是每个键存储M个位，并使用`bit-number/M`获取键名，并使用`bit-number MOD M`来寻址键内的第N位。



## 性能

`SETBIT` 和 `GETBIT` 的时间复杂度为 O(1)。
`BITOP` 的时间复杂度为 O(n)，其中 _n_ 是比较的最长字符串的长度。

## 了解更多

* [Redis 位图详解](https://www.youtube.com/watch?v=oj8LdJQjhJo) 教你如何在在线游戏中使用位图进行地图探索。
* [Redis University 的 "RU101"](https://university.redis.com/courses/ru101/) 详细介绍了 Redis 位图。
