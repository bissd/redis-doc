---
title: "Redis信号处理"
linkTitle: "信号处理"
weight: 8
description: Redis是如何处理常见的Unix信号的
aliases:
    - /topics/signals
---

该文档提供有关Redis如何响应不同的POSIX信号，例如`SIGTERM`和`SIGSEGV`的信息。

以下文档中的信息**仅适用于Redis 2.6或更高版本**。

## SIGTERM 和 SIGINT

`SIGTERM`和`SIGINT`信号告诉Redis要优雅地关闭。当服务器接收到这个信号时，它不会立即退出。相反，它会安排一个类似于`SHUTDOWN`命令所执行的关闭操作。安排的关闭会尽快开始，具体取决于当前执行的命令是否终止（如果有的话），可能还会有额外的0.1秒或更短的延迟。

如果服务器被长时间运行的Lua脚本阻塞，如果可能的话，使用`SCRIPT KILL`命令杀死脚本。计划的关闭将在脚本被杀死或自动终止后执行。

这个关闭过程包括以下操作：

* 如果存在落后于复制的副本：
  * 使用`CLIENT PAUSE`和`WRITE`选项暂停试图写入的客户端。
  * 等待配置的`shutdown-timeout`（默认为10秒），以使副本追上主节点的复制偏移量。
* 如果后台子进程正在保存RDB文件或执行AOF重写，则终止该子进程。
* 如果AOF处于活动状态，Redis会对AOF文件描述符调用`fsync`系统调用，以刷新磁盘上的缓冲区。
* 如果Redis配置为使用RDB文件在磁盘上持久化，则执行同步（阻塞）保存。由于保存是同步的，因此不使用任何额外的内存。
* 如果服务器是后台化的，则删除PID文件。
* 如果启用了Unix域套接字，则删除它。
* 服务器以退出码为零的方式退出。

如果无法保存RDB文件，关机失败，服务器继续运行以确保不丢失数据。
同样地，如果用户刚刚启用AOF，并且服务器触发了第一次AOF重写以创建初始AOF文件，但该文件无法保存，则关机失败，服务器继续运行。
自Redis 2.6.11以来，除非收到新的`SIGTERM`或发出`SHUTDOWN`命令，否则不会再尝试关机。

自Redis 7.0版本开始，服务器在关闭之前会等待落后的副本，等待时间可由配置项`shutdown-timeout`控制，默认为10秒。
这样可以尽力减少在没有配置保存点且关闭了AOF的情况下数据丢失的风险。
在7.0版本之前，在无磁盘设置下关闭负载较重的主节点更可能导致数据丢失。
为了在这种设置中最小化数据丢失的风险，在关闭主节点之前触发手动的`FAILOVER`（或`CLUSTER FAILOVER`）命令，将主节点降级为副本，并将一个副本升级为新的主节点。

## SIGSEGV，SIGBUS，SIGFPE和SIGILL

以下信号被视为Redis崩溃：

* SIGSEGV
* SIGBUS
* SIGFPE
* SIGILL

一旦捕获到这些信号之一，Redis将停止当前的任何操作并执行以下操作：

* 将错误报告添加到日志文件中。这包括堆栈跟踪、寄存器转储和关于客户端状态的信息。
* 自从Redis 2.8版本以来，首先会进行快速的内存测试，以检查系统的可靠性。
* 如果服务器已守护运行，则会删除PID文件。
* 最后，服务器取消注册接收信号的自己的信号处理程序，并向自己重新发送相同的信号，以确保执行默认操作，例如在文件系统上转储核心。

## 当子进程被终止时会发生什么

当执行“附加模式下重写 AOF 文件”操作的子进程被信号杀死时，Redis 会将其视为错误，并丢弃（可能是部分或损坏的）AOF 文件。Redis 会稍后再次尝试重写操作。

当执行RDB保存的子进程被杀死时，Redis将其视为更严重的错误处理。虽然AOF文件重写的失败可能导致AOF文件的扩大，但RDB文件创建失败会降低数据的持久性。

由于子进程生成的RDB文件被信号杀死，或者当子进程以错误退出（非零退出代码），Redis进入特殊的错误状态，此时将不再接受进一步的写入命令。

- Redis将继续回复读命令。
- Redis将对所有写命令回复一个"MISCONFIG"错误。

在成功创建RDB文件之前，此错误条件将持续存在。

## 删除RDB文件时不产生错误

有时用户可能希望在不生成错误的情况下终止保存 RDB 的子进程。从 Redis 版本 2.6.10 开始，可以使用信号 `SIGUSR1` 来实现这个目的。这个信号的处理方式是特殊的：它像其他信号一样终止子进程，但父进程不会将其视为严重错误，而是继续处理写请求。
