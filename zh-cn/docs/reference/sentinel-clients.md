---
title: "哨兵客户端规范"
linkTitle: "哨兵客户端"
weight: 2
description: 如何为Redis Sentinel构建客户端
aliases:
  - /topics/sentinel-clients
---

Redis Sentinel是Redis实例的监控解决方案，它处理Redis主节点的自动故障转移和服务发现（对于给定组实例，谁是当前的主节点？）。由于Sentinel负责在故障转移期间重新配置实例，并为连接到Redis主节点或副本的客户端提供配置，因此客户端需要明确支持Redis Sentinel。

本文面向希望在其客户端实现中支持Sentinel的Redis客户端开发人员，其目标如下：

* 通过Sentinel自动配置客户端。
* 提高了Redis Sentinel自动故障转移的安全性。

关于Redis Sentinel的工作原理的详细信息，请参阅[Redis文档](/topics/sentinel) ，因为本文档只包含Redis客户端开发人员所需的信息，并且预期读者熟悉Redis Sentinel的工作方式。

## 通过 Sentinel 进行 Redis 服务发现

Redis Sentinel 使用类似 "stats" 或 "cache" 的名称来标识每个主节点。
实际上，每个名称都标识一个由一个主节点和可变数量的从节点组成的 *实例组*。

特定网络中用于特定目的的Redis主节点的地址可能会在自动故障转移、手动触发的故障转移（例如为了升级Redis实例）和其他原因后发生变化。

通常情况下，Redis客户端会有一些硬编码的配置，用于指定网络中Redis主实例的地址，包括IP地址和端口号。然而，如果主地址发生变化，则需要手动干预每个客户端。

支持Sentinel的Redis客户端可以通过Redis Sentinel自动发现Redis主节点的地址，而不是使用硬编码的IP地址和端口。因此，一个支持Sentinel的客户端应该能够选择性地以以下方式输入：

* 已知哨兵实例的ip:port对列表。
* 服务的名称，如"cache"或"timelines"。

以下是客户获取主地址的步骤，从哨兵列表和服务名称开始。

第1步：连接到第一个哨兵节点
---

客户端应该迭代Sentinel地址列表。对于每个地址，它应该尝试连接到Sentinel，使用较短的超时时间（几百毫秒的数量级）。在错误或超时时，应该尝试下一个Sentinel地址。

如果尝试了所有的Sentinel地址都没有成功，应该向客户端返回错误。

在重新连接时，应将第一个回复客户端请求的 Sentinel 放在列表的开头，这样在下次重新连接时，我们将首先尝试在上一次连接尝试中可达的 Sentinel，以最小化延迟。

第二步：询问主地址

一旦与Sentinel建立连接，客户端应该重试执行以下命令:

    SENTINEL get-master-addr-by-name master-name

其中 *master-name* 应该被替换为用户指定的实际服务名称。

这个调用的结果可以是以下两个回复之一：

* 一个 IP:端口 对。
* 一个空回复。这意味着 Sentinel 不知道这个主节点。

如果收到一个ip:port对，应使用此地址连接到Redis主机。否则，如果收到空回复，则客户端应尝试列表中的下一个Sentinel。

步骤3：在目标实例中调用ROLE命令

客户端一旦发现主实例的地址，应该尝试与主实例建立连接，并调用 `ROLE` 命令来验证实例的角色是否确实是主服务器。

如果“ROLE”命令不可用（它在Redis 2.8.12中引入），客户端可以通过解析输出的`role:`字段来使用“INFO replication”命令。

如果实例不像预期的那样是主实例，则客户端应该等待一小段时间（几百毫秒）并从步骤1开始再次尝试。

处理重新连接
===

一旦服务名称解析为主地址，并且与Redis主实例建立连接，每次需要重新连接时，客户端应该重新解析地址，从第1步重新开始使用Sentinels。例如，Sentinel应该在以下情况下再次联系：

* 如果客户端在超时或套接字错误后重新连接。
* 如果客户端因为明确关闭或用户重新连接而重新连接。

在上述情况以及客户端与Redis服务器失去连接的任何其他情况下，客户端应重新解析主服务器地址。

Sentinel故障切换断开连接

从Redis 2.8.12开始，当Redis Sentinel更改实例的配置时，例如将副本升级为主节点，将主节点降级为副本节点，在故障转移后使副本节点重新复制到新的主节点，或者只是改变陈旧副本实例的主节点地址，它会向实例发送"CLIENT KILL type normal"命令，以确保所有客户端都与重新配置的实例断开连接。这将强制客户端重新解析主节点地址。

如果客户端将与尚未更新信息的Sentinel联系，通过`ROLE`命令验证Redis实例角色将失败，允许客户端检测到所联系的Sentinel提供了过时的信息，并将尝试再次连接。

注意: 当客户端联系到一个陈旧的 Sentinel 实例时，可能会同时返回一个陈旧的主节点，所以客户端可能会连接到一个陈旧的主节点，但是 ROLE 命令的输出结果依然匹配。然而，当主节点再次恢复时，Sentinel 会尝试将其降级为从节点，从而触发一个新的断开连接。同样的原理也适用于连接到陈旧的从节点，它们将被重新配置以与不同的主节点进行复制。

连接到副本
===

有时客户有兴趣连接到副本，例如为了扩展读请求。该协议通过稍微修改步骤2来支持连接到副本。不用调用以下命令：

    SENTINEL get-master-addr-by-name master-name

客户应该打电话而不是：

    SENTINEL replicas master-name

为了检索副本实例列表。

客户端应对实例使用`ROLE`命令进行验证，以确保其实际上是一个副本，以避免将读查询扩展到主节点。

连接池
===

对于实现连接池的客户端，在重新连接单个连接时，应再次联系Sentinel，在主地址更改的情况下，应关闭所有现有连接并连接到新地址。

错误报告
===


客户端在发生错误的情况下，应正确向用户返回信息。具体而言：

* 如果无法联系到任何 Sentinel（因此客户端无法获取到 `SENTINEL get-master-addr-by-name` 的响应），应返回明确指示 Redis Sentinel 无法访问的错误。
* 如果池中的所有 Sentinel 都回复了一个空响应，则应通过错误消息告知用户 Sentinels 不知道此主服务器的名称。

哨兵列表自动刷新
===

在成功回复“ get-master-addr-by-name”后，客户端可以选择更新其内部Sentinel节点列表，按照以下步骤进行操作：

* 使用命令 `SENTINEL sentinels <master-name>` 获取此主节点的其他 Sentinel 列表。
* 将每个尚不存在于我们列表中的 ip:port 对添加到列表末尾。

客户端无需能够使列表持久性地更新其自己的配置。提升Sentinel列表的内存表示能力已经足够有用，以提高可靠性。

订阅Sentinel事件以提高响应能力
===

[Sentinel文档](/topics/sentinel)显示了客户端如何使用Pub/Sub连接到Sentinel实例，以订阅Redis实例配置的更改。

这个机制可以用来加快客户端的重新配置进程，也就是说，客户端可以通过订阅/发布来监听配置变化的发生，并按照本文档中解释的三个步骤协议来解析新的Redis主服务器（或副本）地址。

然而，通过Pub/Sub接收到的更新消息不应替代上述过程，因为无法保证客户端能够接收到所有的更新消息。

附加信息
===

有关更多信息或讨论此指南的特定方面，请给 [Redis Google Group](https://groups.google.com/group/redis-db) 发送一条消息。
